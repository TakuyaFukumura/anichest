# CSV出力・入力機能実装レポート

## 概要

アニメデータのCSV形式での出力・入力機能を実装しました。この機能により、ユーザーはアニメデータのバックアップや一括管理が可能になります。

## 実装された機能

### 1. CSV出力機能

- **アクセス方法**: ホーム画面右上のメニューボタン → 「CSVエクスポート」
- **出力内容**: 登録されている全アニメデータ
- **ファイル名形式**: `anime_export_YYYY-MM-DD_HH-mm-ss.csv`
- **データ形式**: UTF-8エンコーディング、RFC 4180準拠

#### 出力項目
| 項目 | 説明 | 例 |
|------|------|-----|
| title | アニメタイトル | 星空の騎士団 |
| totalEpisodes | 全話数 | 24 |
| genre | ジャンル（カンマ区切り） | ファンタジー,アドベンチャー |
| year | 放送年 | 2023 |
| description | 作品説明 | 魔法の力を失った世界で... |
| imageUrl | 画像URL | https://example.com/image.jpg |

### 2. CSV入力機能

- **アクセス方法**: ホーム画面右上のメニューボタン → 「CSVインポート」
- **対応形式**: UTF-8エンコーディングのCSVファイル
- **重複処理**: タイトルが完全一致する場合は登録をスキップ
- **結果表示**: 成功件数、スキップ件数、エラー詳細を通知

#### インポート結果の例
```
3件のアニメを登録しました
2件のアニメがスキップされました（既存タイトル）
```

## 技術仕様

### CSV形式の仕様

#### エスケープ処理
- カンマ、改行、引用符を含むフィールドは引用符で囲む
- フィールド内の引用符は二重引用符でエスケープ

**例:**
```csv
title,totalEpisodes,genre,year,description,imageUrl
"アニメタイトル,サブタイトル",12,ドラマ,2023,"説明文",""
"引用符""付き""タイトル",24,コメディ,2024,"詳細説明",https://example.com
```

#### 文字エンコーディング
- UTF-8（BOMなし）
- 日本語文字の完全サポート

### アーキテクチャ

#### 新規追加クラス

1. **CsvUtils** (`app/src/main/java/com/anichest/app/util/CsvUtils.kt`)
   - CSV出力・入力の中核処理を担当
   - RFC 4180準拠のCSVパーサー実装
   - エスケープ処理とエラーハンドリング

2. **CsvViewModel** (`app/src/main/java/com/anichest/app/ui/viewmodel/CsvViewModel.kt`)
   - CSV機能のUI状態管理
   - 非同期処理の制御
   - エラー処理とユーザーフィードバック

#### 既存クラスの拡張

1. **AnimeDao** - `existsByTitle`メソッド追加
2. **AnimeRepository** - `exportToCsv`と`importFromCsv`メソッド追加
3. **HomeScreen** - CSV機能用UIコンポーネント追加

### エラーハンドリング

#### インポート時のエラー対応
- ファイル読み込み失敗
- CSV形式エラー（フィールド数不足等）
- データベース挿入エラー
- 必須フィールド（タイトル）の欠損

#### ユーザーへの通知
- Snackbarによるリアルタイム通知
- 詳細なエラーメッセージの表示
- 処理進行状況の可視化

## 使用方法

### CSV出力手順

1. ホーム画面を開く
2. 右上のメニューボタン（⋮）をタップ
3. 「CSVエクスポート」を選択
4. ファイル保存場所を選択
5. エクスポート完了の通知を確認

### CSV入力手順

1. ホーム画面を開く
2. 右上のメニューボタン（⋮）をタップ
3. 「CSVインポート」を選択
4. インポートするCSVファイルを選択
5. 処理結果の通知を確認

## 品質保証

### テスト実装

**CsvUtilsTest** (`app/src/test/java/com/anichest/app/util/CsvUtilsTest.kt`)
- ファイル名生成テスト
- CSV出力機能テスト
- エスケープ処理テスト（カンマ、引用符）
- 基本フィールドパースのテスト

### 検証項目

- [x] 全ユニットテスト通過（14/14テスト）
- [x] ビルド成功確認
- [x] Lintチェック通過
- [x] 日本語文字の正確な処理
- [x] CSV形式の標準準拠
- [x] エラーケースの適切な処理

## バージョン管理

### セマンティックバージョニング
- **変更前**: v0.7.2 (versionCode: 10)
- **変更後**: v0.8.0 (versionCode: 11)
- **理由**: 新機能追加のためマイナーバージョンアップ

## 今後の改善点

### 機能拡張案
1. **エクスポート設定**
   - 出力するフィールドの選択機能
   - 条件絞り込み（年代、ジャンル等）による部分エクスポート

2. **インポート機能強化**
   - CSV形式の自動検出
   - プレビュー機能（インポート前の確認）
   - インポート設定（重複処理方法の選択）

3. **ファイル管理**
   - 定期的な自動バックアップ
   - クラウドストレージ連携

### パフォーマンス改善
1. **大容量データ対応**
   - ストリーミング処理による大容量CSVファイルのサポート
   - バッチ処理による効率的なデータベース操作

2. **ユーザーエクスペリエンス**
   - 処理進捗バーの表示
   - バックグラウンド処理化
   - 処理中断機能

## まとめ

CSV出力・入力機能の実装により、ユーザーはアニメデータの効率的なバックアップと一括管理が可能になりました。実装は標準的なCSV形式に準拠し、日本語を含む多様なデータに対応しています。また、包括的なテストと品質チェックにより、安定した動作を保証しています。

---

**実装日**: 2024年12月19日  
**対応課題**: #40 アニメデータCSV出力＆入力機能実装  
**実装者**: GitHub Copilot