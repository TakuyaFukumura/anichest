# ダークモード切り替え機能 - 実装仕様書

## 概要

アニメ視聴管理アプリ「Anichest」にダークモード切り替え機能を実装しました。ユーザーはシステム設定、ライトモード、ダークモードの3つのテーマから選択でき、設定は永続化されてアプリ再起動後も保持されます。

## 機能仕様

### テーマモード
- **システム設定**: OSのダークモード設定に自動的に追従（デフォルト）
- **ライトモード**: 常にライトテーマを使用
- **ダークモード**: 常にダークテーマを使用

### UI/UX
- ホーム画面のTopAppBarに設定ボタン（⚙️アイコン）を配置
- ボタンタップで循環的にテーマモードが切り替わる：システム → ライト → ダーク → システム...
- 現在のテーマモードがアクセシビリティ対応でボタンの説明文に表示
- テーマ変更は即座にアプリ全体に反映

### データ永続化
- Android Jetpack DataStore（Preferences）を使用
- アプリ終了後も設定が保持される
- 軽量で高性能な設定管理

## 技術実装

### アーキテクチャ
```
UI Layer (Compose)
    ↓
ViewModel (StateFlow)
    ↓  
Repository (DataStore)
    ↓
Data Layer (Preferences)
```

### 主要コンポーネント

#### 1. データレイヤー
- **ThemePreferences.kt**: テーマ設定のデータクラス
- **ThemePreferencesRepository.kt**: DataStoreを使用した設定の永続化管理

#### 2. ビジネスロジック
- **ThemeViewModel.kt**: テーマ状態管理とUIロジック

#### 3. UIレイヤー
- **Theme.kt**: ThemeModeパラメータに対応したテーマ適用
- **MainActivity.kt**: アプリ全体のテーマ状態管理
- **HomeScreen.kt**: テーマ切り替えボタンの実装

### 依存関係
```kotlin
// DataStore
implementation("androidx.datastore:datastore-preferences:1.1.1")

// テスト依存関係
testImplementation("org.jetbrains.kotlinx:kotlinx-coroutines-test:1.9.0")
testImplementation("org.mockito:mockito-core:5.14.2")
```

## 使用方法

### 基本操作
1. アプリ起動後、ホーム画面の右上の設定ボタンをタップ
2. タップするたびにテーマモードが切り替わる
3. 設定は自動的に保存され、アプリ再起動後も有効

### テーマ切り替えの流れ
```
初回起動: システム設定
    ↓ ボタンタップ
ライトモード
    ↓ ボタンタップ  
ダークモード
    ↓ ボタンタップ
システム設定（元に戻る）
```

## テスト

### ユニットテスト
- ThemeViewModelの動作検証
- テーマモード切り替えロジックのテスト
- 循環切り替えの正確性確認

### 動作確認項目
1. ✅ ボタンによるテーマ切り替え
2. ✅ 設定の永続化
3. ✅ アプリ再起動後の設定復元
4. ✅ アクセシビリティ対応
5. ✅ パフォーマンス（リアルタイム反映）

## バージョン情報

- **リリースバージョン**: 4.2.0 (versionCode: 22)
- **前バージョンからの変更**: マイナーバージョンアップ（新機能追加）
- **セマンティックバージョニング準拠**: MAJOR.MINOR.PATCH

## 技術的考慮事項

### パフォーマンス
- StateFlowによるリアクティブプログラミングで効率的な状態管理
- DataStoreの非同期処理でUIブロッキングを回避
- 軽量なenum値による設定管理

### アクセシビリティ
- 設定ボタンに適切なcontentDescription設定
- 現在のテーマモードを音声読み上げ対応

### 保守性
- Hilt DIによる依存関係の管理
- 単一責任原則に基づくクラス設計
- 包括的なユニットテスト

## 将来の拡張可能性

### 予定される機能
- より詳細なテーマ設定画面
- カスタムカラーテーマの追加
- ダークモードの自動切り替えスケジュール

### 技術的拡張
- 他の設定項目のDataStore統合
- Material You動的カラーの詳細制御
- テーマプレビュー機能

---

**実装者**: GitHub Copilot  
**レビュー**: TakuyaFukumura  
**実装日**: 2025年1月  
**ドキュメント更新**: v4.2.0リリース時
